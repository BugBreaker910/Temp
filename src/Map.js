import React, { useEffect, useState } from 'react';
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = 'https://wlrpijvjqwjkwabslcwt.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndscnBpanZqcXdqa3dhYnNsY3d0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTYxMTE3MzIsImV4cCI6MjAzMTY4NzczMn0.AvnrtLse_w_BV1mhOoKnLGKIHsFazBidXnYhEeuxKOs';

const supabase = createClient(supabaseUrl, supabaseKey);

// Define the bus icon
// const busIcon = new L.Icon({
//   iconUrl: '/images/bus.png', // Path to your bus image
//   iconSize: [10, 10],
// });

// Define the nearest point icon
const nearestPointIcon = new L.Icon({
  iconUrl: '/images/bus.png', // Path to your nearest point image
  iconSize: [10, 10],
});

const Map = () => {
  const [locations, setLocations] = useState([]);
  const [nearestPoints, setNearestPoints] = useState([]);

  // Array of fixed latitude and longitude points (direct input values as requested)
  const fixedPoints = [
    [28.525563806360353, 77.5716980171931],
    [28.525567026591837, 77.57168840616254],
    [28.52557024682332, 77.57167879513197],
    [28.525573467054805, 77.57166918410141],
    [28.52557668728629, 77.57165957307085],
    [28.525579907517773, 77.57164996204028],
    [28.525583127749258, 77.57164035100972],
    [28.52558634798074, 77.57163073997916],
    [28.525589568212226, 77.57162112894859],
    [28.525592788443713, 77.57161151791803],
    [28.525596008675198, 77.57160190688747],
    [28.52559922890668, 77.5715922958569],
    [28.525602449138166, 77.57158268482634],
    [28.52560566936965, 77.57157307379576],
    [28.525608889601134, 77.5715634627652],
    [28.52561210983262, 77.57155385173463],
    [28.525615330064102, 77.57154424070407],
    [28.525618550295587, 77.57153462967351],
    [28.52562177052707, 77.57152501864294],
    [28.525624990758555, 77.57151540761238],
    [28.52562821099004, 77.57150579658182],
    [28.525631431221523, 77.57149618555125],
    [28.525634651453007, 77.57148657452069],
    [28.52563787168449, 77.57147696349013],
    [28.525641091915976, 77.57146735245956],
    [28.52564431214746, 77.571457741429],
    [28.525647532378947, 77.57144813039844],
    [28.52565075261043, 77.57143851936787],
    [28.525653972841916, 77.57142890833731],
    [28.5256571930734, 77.57141929730675],
    [28.525660413304884, 77.57140968627618],
    [28.525663633536368, 77.57140007524562],
    [28.525666853767852, 77.57139046421506],
    [28.525670073999336, 77.5713808531845],
    [28.52567329423082, 77.57137124215393],
    [28.525676514462305, 77.57136163112337],
    [28.52567973469379, 77.5713520200928],
    [28.525682954925273, 77.57134240906223],
    [28.525686175156757, 77.57133279803166],
    [28.52568939538824, 77.5713231870011],
    [28.525692615619725, 77.57131357597054],
    [28.52569583585121, 77.57130396493997],
    [28.525699056082694, 77.57129435390941],
    [28.525702276314178, 77.57128474287885],
    [28.525705496545665, 77.57127513184828],
    [28.52570871677715, 77.57126552081772],
    [28.525711937008634, 77.57125590978715],
    [28.525715157240118, 77.57124629875659],
    [28.525718377471602, 77.57123668772603],
    [28.525721597703086, 77.57122707669546],
    [28.52572481793457, 77.5712174656649],
    [28.525728038166054, 77.57120785463434],
    [28.52573125839754, 77.57119824360377],
    [28.525734478629023, 77.57118863257321],
    [28.525737698860507, 77.57117902154265],
    [28.52574091909199, 77.57116941051208],
    [28.525744139323475, 77.57115979948152],
    [28.52574735955496, 77.57115018845096],
    [28.525750579786443, 77.5711405774204],
    [28.525753800017927, 77.57113096638983],
    [28.52575702024941, 77.57112135535927],
    [28.5257602404809, 77.57111174432869],
    [28.525763460712383, 77.57110213329813],
    [28.525766680943867, 77.57109252226756],
    [28.52576990117535, 77.571082911237],
    [28.525773121406836, 77.57107330020644],
    [28.52577634163832, 77.57106368917587],
    [28.525779561869804, 77.57105407814531],
    [28.525782782101288, 77.57104446711475],
    [28.525786002332772, 77.57103485608418],
    [28.525789222564256, 77.57102524505362],
    [28.52579244279574, 77.57101563402306],
    [28.525795663027225, 77.57100602299249],
    [28.52579888325871, 77.57099641196193],
    [28.525802103490193, 77.57098680093137],
    [28.525805323721677, 77.5709771899008],
    [28.52580854395316, 77.57096757887024],
    [28.525811764184645, 77.57095796783968],
    [28.525814984416133, 77.57094835680911],
    [28.525818204647617, 77.57093874577855],
    [28.5258214248791, 77.57092913474798],
    [28.525824645110585, 77.57091952371742],
    [28.52582786534207, 77.57090991268686],
    [28.525831085573554, 77.5709003016563],
    [28.525834305805038, 77.57089069062573],
    [28.525837526036522, 77.57088107959515],
    [28.525840746268006, 77.57087146856459],
    [28.52584396649949, 77.57086185753403],
    [28.525847186730974, 77.57085224650346],
    [28.52585040696246, 77.5708426354729],
    [28.525853627193943, 77.57083302444234],
    [28.525856847425427, 77.57082341341177],
    [28.52586006765691, 77.57081380238121],
    [28.525863287888395, 77.57080419135065],
    [28.52586650811988, 77.57079458032008],
    [28.525869728351363, 77.57078496928952],
    [28.52587294858285, 77.57077535825896],
    [28.525876168814335, 77.57076574722839],
    [28.52587938904582, 77.57075613619783],
    [28.525882609277303, 77.57074652516727],
    [28.525885829508788, 77.5707369141367],
    [28.52588904974027, 77.57072730310614],
    [28.525892269971756, 77.57071769207558],
    [28.52589549020324, 77.57070808104501],
    [28.525898710434724, 77.57069847001445],
    [28.52590193066621, 77.57068885898389],
    [28.525905150897692, 77.57067924795332],
    [28.525908371129177, 77.57066963692276],
    [28.52591159136066, 77.5706600258922],
    [28.525914811592145, 77.57065041486162],
    [28.52591803182363, 77.57064080383105],
    [28.525921252055113, 77.57063119280049],
    [28.525924472286597, 77.57062158176993],
    [28.525927692518085, 77.57061197073936],
    [28.52593091274957, 77.5706023597088],
    [28.525934132981053, 77.57059274867824],
    [28.525937353212537, 77.57058313764767],
    [28.52594057344402, 77.57057352661711],
    [28.525943793675506, 77.57056391558655],
    [28.52594701390699, 77.57055430455598],
    [28.525950234138474, 77.57054469352542],
    [28.525953454369958, 77.57053508249486],
    [28.525953454369958, 77.57053508249486],
    [28.526057101677786, 77.57056629997933],
    [28.526015038993794, 77.57054749515723],
    [28.525972976309806, 77.57052869033514],
    [28.525930913625814, 77.57050988551303],
    [28.525888850941822, 77.57049108069093],
    [28.525846788257834, 77.57047227586882],
    [28.525804725573842, 77.57045347104673],
    [28.52576266288985, 77.57043466622463],
    [28.52572060020586, 77.57041586140252],
    [28.52567853752187, 77.57039705658042],
    [28.525636474837878, 77.57037825175833],
    [28.52559441215389, 77.57035944693622],
    [28.525552349469898, 77.57034064211412],
    [28.525510286785906, 77.57032183729201],
    [28.525468224101918, 77.57030303246992],
    [28.525426161417926, 77.57028422764782],
    [28.525384098733934, 77.57026542282571],
    [28.525342036049945, 77.57024661800361],
    [28.525299973365954, 77.57022781318152],
    [28.52525791068196, 77.57020900835941],
    [28.525215847997973, 77.57019020353731],
    [28.52517378531398, 77.5701713987152],
    [28.52513172262999, 77.57015259389311],
    [28.525089659946, 77.57013378907101],
    [28.52504759726201, 77.5701149842489],
    [28.525005534578018, 77.57009617942681],
    [28.52496347189403, 77.57007737460471],
    [28.524921409210037, 77.5700585697826],
    [28.524879346526046, 77.5700397649605],
    [28.524837283842057, 77.57002096013841],
    [28.524795221158065, 77.5700021553163],
    [28.524753158474073, 77.5699833504942],
    [28.524711095790085, 77.5699645456721],
    [28.524669033106093, 77.56994574085],
    [28.5246269704221, 77.5699269360279],
    [28.524584907738113, 77.56990813120579],
    [28.52454284505412, 77.56988932638369],
    [28.52450078237013, 77.5698705215616],
    [28.52445871968614, 77.56985171673949],
    [28.52441665700215, 77.56983291191739],
    [28.524374594318157, 77.56981410709528],
    [28.52433253163417, 77.56979530227319],
    [28.524290468950177, 77.56977649745109],
    [28.524248406266185, 77.56975769262898],
    [28.524206343582197, 77.56973888780688],
    [28.524164280898205, 77.56972008298479],
    [28.524122218214213, 77.56970127816268],
    [28.524080155530225, 77.56968247334058],
    [28.524038092846233, 77.56966366851849],
    [28.52399603016224, 77.56964486369638],
    [28.523953967478253, 77.56962605887428],
    [28.52391190479426, 77.56960725405217],
    [28.52386984211027, 77.56958844923008],
    [28.52382777942628, 77.56956964440798],
    [28.52378571674229, 77.56955083958587],
    [28.523743654058297, 77.56953203476377],
    [28.52370159137431, 77.56951322994168],
    [28.523659528690317, 77.56949442511957],
    [28.523617466006325, 77.56947562029747],
    [28.523575403322337, 77.56945681547536],
    [28.523533340638345, 77.56943801065327],
    [28.523491277954353, 77.56941920583117],
    [28.523449215270364, 77.56940040100906],
    [28.523407152586373, 77.56938159618696],
    [28.52336508990238, 77.56936279136487],
    [28.523323027218392, 77.56934398654276],
    [28.5232809645344, 77.56932518172066],
    [28.52323890185041, 77.56930637689855],
    [28.52319683916642, 77.56928757207646],
    [28.52315477648243, 77.56926876725436],
    [28.52315477648243, 77.56926876725436],
        [28.52596098444578, 77.57055086664407],
    [28.52600301203352, 77.57057032159088],
    [28.526045039621255, 77.57058977653769],
    [28.526087067208994, 77.5706092314845],
    [28.526129094796733, 77.5706286864313],
    [28.526171122384472, 77.57064814137811],
    [28.526213149972207, 77.57066759632492],
    [28.526255177559946, 77.57068705127173],
    [28.526297205147685, 77.57070650621854],
    [28.526339232735424, 77.57072596116535],
    [28.52638126032316, 77.57074541611216],
    [28.526423287910898, 77.57076487105897],
    [28.526465315498637, 77.57078432600578],
    [28.526507343086376, 77.57080378095259],
    [28.52654937067411, 77.5708232358994],
    [28.52659139826185, 77.5708426908462],
    [28.52663342584959, 77.57086214579303],
    [28.526675453437324, 77.57088160073984],
    [28.526717481025063, 77.57090105568665],
    [28.526759508612802, 77.57092051063346],
    [28.52680153620054, 77.57093996558027],
    [28.526843563788276, 77.57095942052707],
    [28.526885591376015, 77.57097887547388],
    [28.526927618963754, 77.5709983304207],
    [28.526969646551493, 77.5710177853675],
    [28.527011674139228, 77.57103724031431],
    [28.527053701726967, 77.57105669526112],
    [28.527095729314706, 77.57107615020793],
    [28.527137756902444, 77.57109560515474],
    [28.52717978449018, 77.57111506010155],
    [28.52722181207792, 77.57113451504836],
    [28.527263839665657, 77.57115396999517],
    [28.527305867253393, 77.57117342494197],
    [28.52734789484113, 77.57119287988878],
    [28.52738992242887, 77.5712123348356],
    [28.52743195001661, 77.5712317897824],
    [28.527473977604345, 77.57125124472921],
    [28.527516005192084, 77.57127069967602],
    [28.527558032779822, 77.57129015462283],
    [28.52760006036756, 77.57130960956964],
    [28.527642087955297, 77.57132906451645],
    [28.527684115543035, 77.57134851946326],
    [28.527726143130774, 77.57136797441007],
    [28.527768170718513, 77.57138742935688],
    [28.52781019830625, 77.57140688430368],
    [28.527852225893987, 77.57142633925051],
    [28.527894253481726, 77.57144579419732],
    [28.52793628106946, 77.57146524914413],
    [28.5279783086572, 77.57148470409093],
    [28.52802033624494, 77.57150415903774],
    [28.528062363832678, 77.57152361398455],
    [28.528104391420413, 77.57154306893136],
    [28.528146419008152, 77.57156252387817],
    [28.52818844659589, 77.57158197882498],
    [28.52823047418363, 77.57160143377179],
    [28.528272501771365, 77.5716208887186],
    [28.528314529359104, 77.57164034366541],
    [28.528356556946843, 77.57165979861222],
    [28.52839858453458, 77.57167925355903],
    [28.528440612122317, 77.57169870850583],
    [28.528482639710056, 77.57171816345264],
    [28.528482639710056, 77.57171816345264],
    [28.52859554920394, 77.57176100092393],
    [28.52863045737409, 77.57179375082455],
    [28.52866536554424, 77.5718265007252],
    [28.52870027371439, 77.57185925062582],
    [28.528735181884535, 77.57189200052645],
    [28.528770090054685, 77.57192475042709],
    [28.528804998224835, 77.57195750032771],
    [28.528839906394985, 77.57199025022834],
    [28.528874814565135, 77.57202300012898],
    [28.528909722735285, 77.5720557500296],
    [28.528944630905436, 77.57208849993023],
    [28.528979539075582, 77.57212124983087],
    [28.529014447245732, 77.5721539997315],
    [28.529049355415882, 77.57218674963212],
    [28.529084263586032, 77.57221949953276],
    [28.529119171756182, 77.57225224943339],
    [28.529154079926332, 77.57228499933402],
    [28.529188988096482, 77.57231774923466],
    [28.52922389626663, 77.57235049913528],
    [28.52925880443678, 77.57238324903591],
    [28.52929371260693, 77.57241599893655],
    [28.52932862077708, 77.57244874883718],
    [28.52936352894723, 77.5724814987378],
    [28.52939843711738, 77.57251424863844],
    [28.52943334528753, 77.57254699853907],
    [28.529468253457676, 77.5725797484397],
    [28.529503161627826, 77.57261249834033],
    [28.529538069797976, 77.57264524824096],
    [28.529572977968126, 77.57267799814159],
    [28.529607886138276, 77.57271074804223],
    [28.529642794308426, 77.57274349794285],
    [28.529677702478576, 77.57277624784348],
    [28.529712610648723, 77.57280899774412],
    [28.529747518818873, 77.57284174764474],
    [28.529782426989023, 77.57287449754537],
    [28.529817335159173, 77.57290724744601],
    [28.529852243329323, 77.57293999734664],
    [28.529887151499473, 77.57297274724726],
    [28.52992205966962, 77.5730054971479],
    [28.52995696783977, 77.57303824704853],
    [28.52999187600992, 77.57307099694916],
    [28.53002678418007, 77.5731037468498],
    [28.53006169235022, 77.57313649675042],
    [28.53009660052037, 77.57316924665105],
    [28.53013150869052, 77.57320199655169],
    [28.530166416860666, 77.57323474645231],
    [28.530201325030816, 77.57326749635294],
    [28.530236233200966, 77.57330024625358],
    [28.530271141371117, 77.5733329961542],
    [28.530306049541267, 77.57336574605483],
    [28.530340957711417, 77.57339849595547],
    [28.530375865881567, 77.5734312458561],
    [28.530410774051713, 77.57346399575673],
    [28.530445682221863, 77.57349674565737],
    [28.530480590392013, 77.57352949555799],
    [28.530515498562163, 77.57356224545862],
    [28.530550406732313, 77.57359499535926],
    [28.530585314902464, 77.57362774525988],
    [28.530620223072614, 77.57366049516051],
    [28.53065513124276, 77.57369324506115],
    [28.53069003941291, 77.57372599496178],
    [28.53072494758306, 77.5737587448624],
    [28.53075985575321, 77.57379149476304],
    [28.53079476392336, 77.57382424466367],
    [28.53082967209351, 77.5738569945643],
    [28.53086458026366, 77.57388974446494],
    [28.530899488433807, 77.57392249436556],
    [28.530934396603957, 77.57395524426619],
    [28.530969304774107, 77.57398799416683],
    [28.531004212944257, 77.57402074406745],
    [28.531039121114407, 77.57405349396808],
    [28.531074029284557, 77.57408624386872],
    [28.531108937454707, 77.57411899376935],
    [28.531143845624854, 77.57415174366997],
    [28.531178753795004, 77.57418449357061],
    [28.531213661965154, 77.57421724347124],
    [28.531248570135304, 77.57424999337186],
    [28.531283478305454, 77.5742827432725],
    [28.531318386475604, 77.57431549317313],
    [28.531353294645754, 77.57434824307376],
    [28.5313882028159, 77.5743809929744],
    [28.53142311098605, 77.57441374287502],
    [28.5314580191562, 77.57444649277565],
    [28.53149292732635, 77.57447924267629],
    [28.5315278354965, 77.57451199257692],
    [28.53156274366665, 77.57454474247754],
    [28.5315976518368, 77.57457749237818],
    [28.531632560006948, 77.57461024227881],
    [28.531667468177098, 77.57464299217943],
    [28.531702376347248, 77.57467574208007],
    [28.531737284517398, 77.5747084919807],
    [28.531772192687548, 77.57474124188133],
    [28.531807100857698, 77.57477399178197],
    [28.531842009027848, 77.5748067416826],
    [28.531876917197994, 77.57483949158322],
    [28.531911825368145, 77.57487224148386],
    [28.531946733538295, 77.57490499138449],
    [28.531981641708445, 77.57493774128511],
    [28.532016549878595, 77.57497049118575],
    [28.532051458048745, 77.57500324108638],
    [28.532086366218895, 77.575035990987],
    [28.53212127438904, 77.57506874088764],
    [28.53215618255919, 77.57510149078827],
    [28.53219109072934, 77.5751342406889],
    [28.53222599889949, 77.57516699058954],
    [28.53226090706964, 77.57519974049016],
    [28.53229581523979, 77.57523249039079],
    [28.532330723409938, 77.57526524029143],
    [28.532365631580088, 77.57529799019206],
    [28.53240053975024, 77.57533074009268],
    [28.53243544792039, 77.57536348999332],
    [28.53247035609054, 77.57539623989395],
    [28.53250526426069, 77.57542898979457],
    [28.53254017243084, 77.57546173969521],
    [28.532575080600985, 77.57549448959584],
    [28.532609988771135, 77.57552723949647],
    [28.532644896941285, 77.5755599893971],
    [28.532679805111435, 77.57559273929773],
    [28.532714713281585, 77.57562548919836],
    [28.532749621451735, 77.575658239099],
    [28.532784529621885, 77.57569098899963],
    [28.532819437792032, 77.57572373890025],
    [28.532854345962182, 77.57575648880089],
    [28.532889254132332, 77.57578923870152],
    [28.532924162302482, 77.57582198860214],
    [28.532959070472632, 77.57585473850278],
    [28.532993978642782, 77.57588748840341],
    [28.533028886812932, 77.57592023830404],
    [28.53306379498308, 77.57595298820468],
    [28.53309870315323, 77.5759857381053],
    [28.53313361132338, 77.57601848800593],
    [28.53316851949353, 77.57605123790657],
    [28.53320342766368, 77.5760839878072],
    [28.53323833583383, 77.57611673770782],
    [28.53327324400398, 77.57614948760846],
    [28.533308152174126, 77.57618223750909],
    [28.533343060344276, 77.57621498740971],
    [28.533377968514426, 77.57624773731035],
    [28.533412876684576, 77.57628048721098],
    [28.533412876684576, 77.57628048721098],
    // Add more fixed points here...
  ];

  useEffect(() => {
    const fetchLocations = async () => {
      const { data, error } = await supabase
        .from('GPS')
        .select('*');
      if (error) console.error('Error fetching data:', error);
      else setLocations(data);
    };

    fetchLocations();
    const interval = setInterval(fetchLocations, 500); // Fetch every 500 milliseconds

    return () => clearInterval(interval); // Cleanup interval on component unmount
  }, []);

  useEffect(() => {
    // Calculate the nearest point from fixedPoints for a given location
    const calculateNearestPoint = (location) => {
      let nearestPoint = null;
      let minDistance = Infinity;

      fixedPoints.forEach(point => {
        const distance = Math.sqrt(
          Math.pow(location.LAT - point[0], 2) + Math.pow(location.LONG - point[1], 2)
        );
        if (distance < minDistance) {
          minDistance = distance;
          nearestPoint = point;
        }
      });

      return nearestPoint;
    };

    if (locations.length > 0) {
      const calculatedNearestPoints = locations.map(location => ({
        id: location.id,
        nearest: calculateNearestPoint(location)
      }));
      setNearestPoints(calculatedNearestPoints);
    }
  }, [locations]);

  return (
    <MapContainer center={[28.525334, 77.573838]} zoom={25} style={{ height: "100vh", width: "100%" }}>
      <TileLayer
        url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
      />
      
      {nearestPoints.map(np => (
        np.nearest && (
          <Marker key={`nearest-${np.id}`} position={np.nearest} icon={nearestPointIcon}>
            <Popup>
              Nearest Point to Shuttle ID: {np.id}
            </Popup>
          </Marker>
        )
      ))}
    </MapContainer>
  );
};

export default Map;
